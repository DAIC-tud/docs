<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.92.2" />
<link rel="alternate" type="text/html" href="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/container_images/_print/">
<link rel="alternate" type="application/rss&#43;xml" href="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/container_images/index.xml">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/daicdocumentation/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/daicdocumentation/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/daicdocumentation/favicons/android-192x192.png" sizes="192x192">

<title>Container images | DAIC documentation</title>
<meta name="description" content="Documentation of compute environments accessible to CS departments in TU Delft">
<meta property="og:title" content="Container images" />
<meta property="og:description" content="Documentation of compute environments accessible to CS departments in TU Delft" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/container_images/" /><meta property="og:site_name" content="DAIC documentation" />

<meta itemprop="name" content="Container images">
<meta itemprop="description" content="Documentation of compute environments accessible to CS departments in TU Delft"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Container images"/>
<meta name="twitter:description" content="Documentation of compute environments accessible to CS departments in TU Delft"/>




<link rel="preload" href="/daicdocumentation/scss/main.scss" as="style">
<link href="/daicdocumentation/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/daicdocumentation/css/prism.css"/>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-00000000-0');
}
</script>
  </head>
  <body class="td-section">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/daicdocumentation/"><span class="navbar-brand__logo navbar-logo"><svg id="logo" viewBox="0 0 27.000001 23.999998" sodipodi:docname="logo.svg" width="27" height="24" inkscape:version="1.1.2 (0a00cf5339, 2022-02-04)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs27"/><sodipodi:namedview id="namedview25" pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" inkscape:pageshadow="2" inkscape:pageopacity="0" inkscape:pagecheckerboard="0" showgrid="false" width="102.89001" height="60.280029" inkscape:zoom="5.25467" inkscape:cx="29.021803" inkscape:cy="24.359284" inkscape:window-width="1920" inkscape:window-height="995" inkscape:window-x="0" inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="g22"/><style id="style2">.st0{fill:none}</style><g id="g22" transform="translate(-72.964861,-182.16415)"><rect x="66.169998" y="175.17" class="st0" width="124.37" height="76.529999" id="rect4"/><path d="m89.093695 193.41093c-1.473161.44928-3.003421.0877-2.992001-1.80805.0-2.89288 7.068887-5.31458 8.050993-7.8349.239818-.62459.262657-1.15057-.0571-1.12866-.228397.011-.04568.32874-.548153.79993-2.923481 2.81618-7.834016 2.80522-11.602566 4.42698-2.466687 1.06292-9.706871 4.32837-8.039574 11.61538.07994.35065.296916 1.50122.513893 1.50122.251237.0.251237-.69034.251237-1.52314-.0571-4.33933 5.29881-5.5447 7.046047-8.38279.205557-.33969.570992-.81089.650931-.59172.04568.10957.01142.26298-.0571.56981-.548153 2.33402-3.083359 3.8243-2.363909 5.4899.936428 2.15871 3.620092.54789 4.453742-.84376.216976-.38353.342594-.6246.491053-.58077.114199.0329.102779.47119.03426.86568-.445374 2.50935-1.039206 3.91196-2.957741 5.34744-.616671.46024-1.575939.5479-1.450321.89856.03426.0877.445375.0767.77655.0439 5.093253-.31778 9.352856-6.07067 10.483422-9.84018.114198-.263.148457-.51502.03426-.60269-.148459-.10957-.376855.14246-.605252.33969-.582413.50407-1.381802 1.01909-2.112672 1.23825z" id="path10" style="stroke-width:1.11865"/></g></svg></span><span class="navbar-brand__name">DAIC documentation</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/daicdocumentation/hpc_users/"><span>Can I use HPC?</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/daicdocumentation/quickstart/"><span>QuickStart</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link active" href="/daicdocumentation/tutorials/"><span class="active">Tutorials</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/daicdocumentation/docs/"><span>Detailed Documentation</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/daicdocumentation/support/"><span>Support</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/daicdocumentation/monitoring/"><span>Monitoring</span></a>
      </li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off">
</div>

  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off">
</div>

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-daicdocumentationtutorials-li">
  <a href="/daicdocumentation/tutorials/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-daicdocumentationtutorials"><span class="">Tutorials</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-daicdocumentationtutorialscontainer_images-li">
  <a href="/daicdocumentation/tutorials/container_images/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialscontainer_images"><span class="td-sidebar-nav-active-item">Container images</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialscpu_gpu_resources-li">
  <a href="/daicdocumentation/tutorials/cpu_gpu_resources/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialscpu_gpu_resources"><span class="">CPU and GPU resources</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialsdeep_learning-li">
  <a href="/daicdocumentation/tutorials/deep_learning/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialsdeep_learning"><span class="">High-Performance Deep Learning</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialsjulia-li">
  <a href="/daicdocumentation/tutorials/julia/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialsjulia"><span class="">Julia in Compute clusters</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialslarge_small_files-li">
  <a href="/daicdocumentation/tutorials/large_small_files/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialslarge_small_files"><span class="">Too many small files</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialsray_cluster-li">
  <a href="/daicdocumentation/tutorials/ray_cluster/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialsray_cluster"><span class="">Ray Cluster</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-daicdocumentationtutorialsnew_page-li">
  <a href="/daicdocumentation/tutorials/new_page/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-daicdocumentationtutorialsnew_page"><span class="">New page</span></a>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/tree/master/content/en/tutorials/container_images/_index.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/edit/master/content/en/tutorials/container_images/_index.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/new/master/content/en/tutorials/container_images/_index.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/issues/new?title=Container%20images" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  <a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/issues/new" class="td-page-meta--project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a>
  <a id="print" href="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/container_images/_print/"><i class="fa-solid fa-print fa-fw"></i> Print entire section</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#containerization-technology">Containerization Technology</a></li>
    <li><a href="#pulling-images">Pulling images</a>
      <ul>
        <li><a href="#pulling-from-dockerhub">Pulling from DockerHub</a></li>
        <li><a href="#pulling-from-nvidia-gpu-cloud-ngc">Pulling from NVIDIA GPU cloud (NGC)</a></li>
      </ul>
    </li>
    <li><a href="#building-images">Building images</a>
      <ul>
        <li><a href="#building-from-local-image-file">Building from local image file</a></li>
        <li><a href="#deploying-conda-in-a-container">Deploying conda in a container</a></li>
      </ul>
    </li>
    <li><a href="#exposing-host-directories">Exposing host directories</a></li>
  </ul>
</nav>
      </div>
    
            

	
		
			
				
			
			



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-tags">
      
        <h5 class="taxonomy-title">Tag Cloud</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" href="https://aeaahmed.gitlab.io/daicdocumentation/tags/docs/" data-taxonomy-term="docs"><span class="taxonomy-label">docs</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="https://aeaahmed.gitlab.io/daicdocumentation/tags/sample/" data-taxonomy-term="sample"><span class="taxonomy-label">sample</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="https://aeaahmed.gitlab.io/daicdocumentation/tags/test/" data-taxonomy-term="test"><span class="taxonomy-label">test</span><span class="taxonomy-count">2</span></a></li>
        
      </ul>
    </div>
  

		
			
				
			
			



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-categories">
      
        <h5 class="taxonomy-title">Categories</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" href="https://aeaahmed.gitlab.io/daicdocumentation/categories/examples/" data-taxonomy-term="examples"><span class="taxonomy-label">Examples</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="https://aeaahmed.gitlab.io/daicdocumentation/categories/placeholders/" data-taxonomy-term="placeholders"><span class="taxonomy-label">Placeholders</span><span class="taxonomy-count">1</span></a></li>
        
      </ul>
    </div>
  

		
	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/">Tutorials</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="https://aeaahmed.gitlab.io/daicdocumentation/tutorials/container_images/" aria-disabled="true" class="btn-link disabled">Container images</a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Container images</h1>
  
	<header class="article-meta">
		

  
    
      


    
      


    
  

		
	</header>
	<h2 id="containerization-technology">Containerization Technology</h2>
<p><em>Containerization</em> is a convenient means to deploy libraries and applications to different environments in a reproducible manner. A <em>container image</em>, typically a <code>*.sif</code> file, is a self-contained file with all necessary components to run an application, including code, runtime libraries, and dependencies.</p>
<p><em>HPC</em> supports <a href="https://apptainer.org/docs/user/main/introduction.html">Apptainer (previously Singularity)</a>, an open-source container platform, designed to run complex applications on HPC clusters. Apptainer makes it possible to use docker images natively  at a higher level of security and isolation. (see <a href="#pulling-images">Pulling images</a>)</p>
<p>Generally, to launch a container image, your commands look as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ apptainer shell &lt;container&gt; <span style="color:#8f5902;font-style:italic"># OR</span>
$ apptainer <span style="color:#204a87">exec</span>  &lt;container&gt; &lt;command&gt;
$ apptainer run   &lt;container&gt;
</code></pre></div><p>where:</p>
<ul>
<li><code>&lt;container&gt;</code> is the path to a container image, typically, a <code>*.sif</code> file</li>
<li><code>&lt;command&gt;</code> is the command you like to run from inside the container, eg, <code>hostname</code></li>
<li>Both <code>shell</code> and <code>exec</code> can be used to launch container images. The difference is that <code>shell</code> allows you to work inside the container image interactively; while <code>exec</code> executes the <code>&lt;command&gt;</code> inside the image and exits. Of course, by using something like <code>/bin/bash</code> as the <code>&lt;command&gt;</code>, <code>exec</code> behaves exactly like <code>shell</code>.</li>
<li><code>run</code> also launches a container image, but runs the default action defined in the container image. See an example use case in <a href="/tutorials/singularity/#building-images">Building images </a></li>
</ul>
<p>The question is now: where to get the <code>&lt;container&gt;</code> file? You can either 1) use a pre-built image by pulling from a repository, or, 2) build your own container image and use it accordingly. The following sections give examples to both options.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    <p>If you intend to extensively work/test your image interactively, it is best to first submit an interactive SLURM job with the needed resources, eg, memory, gpus, &hellip; etc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname  <span style="color:#8f5902;font-style:italic"># To check this is HPC. login[1-3] are the login nodes</span>
login1.hpc.tudelft.nl 
$ sinteractive <span style="color:#8f5902;font-style:italic"># Default resources: --time=01:00:00 --cpus-per-task = 2 --mem=1024 </span>
Note: interactive sessions are automatically terminated when they reach their <span style="color:#204a87">time</span> limit <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> hour<span style="color:#ce5c00;font-weight:bold">)</span>!
srun: job <span style="color:#0000cf;font-weight:bold">8543393</span> queued and waiting <span style="color:#204a87;font-weight:bold">for</span> resources
srun: job <span style="color:#0000cf;font-weight:bold">8543393</span> has been allocated resources
 13:35:30 up <span style="color:#0000cf;font-weight:bold">5</span> days,  3:41,  <span style="color:#0000cf;font-weight:bold">0</span> users,  load average: 8,79, 7,60, 7,11
$ hostname <span style="color:#8f5902;font-style:italic"># To check we are on a compute node</span>
grs3.hpc.tudelft.nl 
</code></pre></div>

</div>

<h2 id="pulling-images">Pulling images</h2>
<p>Many repositories exist where container images are hosted. Apptainer allows pulling and using images from repositories like <a href="https://hub.docker.com/">DockerHub</a>, <a href="https://biocontainers.pro/registry">BioContainers</a> and <a href="https://ngc.nvidia.com/catalog/containers">NVIDIA GPU Cloud (NGC)</a>.</p>
<h3 id="pulling-from-dockerhub">Pulling from DockerHub</h3>
<p>For example, to obtain the latest Ubuntu image from DockerHub:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic"># check this is HPC</span>
login1.hpc.tudelft.nl
$ <span style="color:#204a87">cd</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mkdir containers <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">cd</span> containers <span style="color:#8f5902;font-style:italic"># as convenience, use this directory</span>
$ apptainer pull docker://ubuntu:latest <span style="color:#8f5902;font-style:italic"># actually pull the image</span>
INFO:    Converting OCI blobs to SIF format
INFO:    Starting build...
Getting image <span style="color:#204a87">source</span> signatures
Copying blob 837dd4791cdc <span style="color:#204a87;font-weight:bold">done</span>  
Copying config 1f6ddc1b25 <span style="color:#204a87;font-weight:bold">done</span>  
Writing manifest to image destination
Storing signatures
...
INFO:    Creating SIF file...
</code></pre></div><p>Now, to check the obtained image file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls  
ubuntu_latest.sif
$ apptainer <span style="color:#204a87">exec</span> ubuntu_latest.sif cat /etc/os-release <span style="color:#8f5902;font-style:italic"># execute cat command and exit</span>
<span style="color:#000">PRETTY_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Ubuntu 22.04.2 LTS&#34;</span>
<span style="color:#000">NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Ubuntu&#34;</span>
<span style="color:#000">VERSION_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;22.04&#34;</span>
<span style="color:#000">VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;22.04.2 LTS (Jammy Jellyfish)&#34;</span>
<span style="color:#000">VERSION_CODENAME</span><span style="color:#ce5c00;font-weight:bold">=</span>jammy
<span style="color:#000">ID</span><span style="color:#ce5c00;font-weight:bold">=</span>ubuntu
<span style="color:#000">ID_LIKE</span><span style="color:#ce5c00;font-weight:bold">=</span>debian
<span style="color:#000">HOME_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://www.ubuntu.com/&#34;</span>
<span style="color:#000">SUPPORT_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://help.ubuntu.com/&#34;</span>
<span style="color:#000">BUG_REPORT_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://bugs.launchpad.net/ubuntu/&#34;</span>
<span style="color:#000">PRIVACY_POLICY_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&#34;</span>
<span style="color:#000">UBUNTU_CODENAME</span><span style="color:#ce5c00;font-weight:bold">=</span>jammy

$ ls /.singularity.d/ <span style="color:#8f5902;font-style:italic"># container-specific directory should not be found on host</span>
ls: cannot access /.singularity.d/: No such file or directory

$ apptainer shell ubuntu_latest.sif <span style="color:#8f5902;font-style:italic"># launch container interactively</span>
Apptainer&gt;
Apptainer&gt; hostname
login1.hpc.tudelft.nl
Apptainer&gt; ls
ubuntu_latest.sif
Apptainer&gt; ls /.singularity.d/ 
Singularity  actions  env  labels.json  libs  runscript  startscript
Apptainer&gt; <span style="color:#204a87">exit</span>
</code></pre></div><p>In the above snippet, note:</p>
<ul>
<li>The command prompt changes within the container to <code>Apptainer&gt;</code></li>
<li>The container seamlessly interacts with the host system. For example, it inherits its <code>hostname</code> (the HPC login node in this case). The container also inherits the <code>$HOME</code> variable, and is able to edit/delete files from there.</li>
<li>The container has its own file system, which is distinct from the host. The presence of a directory like <code>/.singularity.d</code> is another feature of the specific to the container.</li>
</ul>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <p>To isolate files in your system (ie, your local machine or <em>HPC</em>) from the files inside the container (and thus, avoid possible erroneous deletes/edits), it is recommended to add a <code>-c</code> or <code>-C</code> flags to your apptainer commands</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ apptainer shell -C ubuntu_latest.sif
</code></pre></div>

</div>

<h3 id="pulling-from-nvidia-gpu-cloud-ngc">Pulling from NVIDIA GPU cloud (NGC)</h3>
<p>This is a specialized registry provided by NVIDIA for GPU accelerated applications or GPU software development tools. These images are large, and one is recommended to download them locally, and only send the downloaded image to <em>HPC</em>. For this, Apptainer needs to be installed on your machine first, as per the official <a href="https://apptainer.org/docs/admin/main/installation.html">Installing Apptainer pages</a>.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    By default, Apptainer images are saved to <code>~/.singularity</code>. Ideally, to avoid quota issues, you&rsquo;d set the environment variable <code>SINGULARITY_CACHEDIR</code> to a different location. At present, both the <code>bulk</code> and <code>umbrella</code> filesystems do not support pulling images, so you are advised to pull these to your local machine and then copy over the image file to <em>HPC</em>.

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic">#check this is your own PC/laptop</span>
$ apptainer pull docker://nvcr.io/nvidia/pytorch:23.05-py3
$ scp pytorch_23.05-py3.sif  hpc-login:/tudelft.net/staff-bulk/...&lt;username&gt;/apptainer
</code></pre></div><p>Now, to check this particular image on <em>HPC</em>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic"># check this is HPC not your own PC/laptop</span>
login1.hpc.tudelft.nl
$ <span style="color:#204a87">cd</span> /tudelft.net/staff-bulk/...&lt;username&gt;/apptainer <span style="color:#8f5902;font-style:italic"># path where you put images</span>
$ apptainer shell -C --nv pytorch_23.05-py3.sif  <span style="color:#8f5902;font-style:italic">#--nv to use NVIDIA GPU and have CUDA support</span>
Apptainer&gt;
Apptainer&gt; hostname
login1.hpc.tudelft.nl <span style="color:#8f5902;font-style:italic"># hostname inherited</span>
Apptainer&gt; ls /.singularity.d/ <span style="color:#8f5902;font-style:italic"># verify this is the image</span>
Singularity  actions  env  labels.json  libs  runscript  startscript
</code></pre></div><h2 id="building-images">Building images</h2>
<p>If you prefer (or need) to have a custom container image, then you can build your own container image from a <em>recipe</em> file, typically <code>*.def</code> file, that sets up the image with your custom dependencies. The only requirement for building is to be in a machine (eg, your local laptop/pc) where you have sudo/root privileges. In other words, you can <strong>not</strong> build images on <em>HPC</em> directly: First, you must build the image locally, and then send it to <em>HPC</em> to run there.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    If Apptainer is not already installed in your machine, follow the official <a href="https://apptainer.org/docs/admin/main/installation.html">Installing Apptainer instructions</a>

</div>

<p>An example <em>recipe</em> file, <code>cuda_based_recipe.def</code>, for a cuda-enabled container may look as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat cuda_based_recipe.def
<span style="color:#8f5902;font-style:italic"># Header</span>
Bootstrap: docker
From: nvidia/cuda:12.1.1-devel-ubuntu22.04

<span style="color:#8f5902;font-style:italic"># (Optional) Sections/ data blobs</span>
%post
    apt-get update <span style="color:#8f5902;font-style:italic"># update system</span>
    apt-get install -y git   <span style="color:#8f5902;font-style:italic"># install git</span>
    git clone https://github.com/NVIDIA/cuda-samples.git  <span style="color:#8f5902;font-style:italic"># clone target repository</span>
    <span style="color:#204a87">cd</span> cuda-samples
    git fetch origin --tags <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> git checkout v12.1 <span style="color:#8f5902;font-style:italic"># fetch certain repository version</span>
    <span style="color:#204a87">cd</span> Samples/1_Utilities/deviceQuery <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make <span style="color:#8f5902;font-style:italic"># install certain tool</span>

%runscript
    /cuda-samples/Samples/1_Utilities/deviceQuery/deviceQuery  
</code></pre></div><p>where:</p>
<ul>
<li>The <em>header</em>, the first 2 lines of this example, specify the source of a base image, (eg, <code>Bootstrap: docker</code>), and the base image (<code>From: nvidia/cuda:12.1.1-devel-ubuntu22.04</code>)
to be pulled from this source. The container image will be built on top of this base image. In this example, the base image will be built from Ubuntu 22.04 OS with the CUDA toolkit 12.1 pre-installed.</li>
<li>The rest of the file are optional <em>data blobs</em> or <em>sections</em>. In this example, the following blobs are used:
<ul>
<li><code>%post</code> blob: the steps to download, configure and install needed custom software and libraries on the base image. In this example, the steps install git, clone a repo, and install a package via <code>make</code></li>
<li><code>%runscript</code> blob: the scripts or commands to execute when the container image is run. That is, this code is the entry point to the container with the <code>run</code> command. In this example, the <code>deviceQuery</code> is executed once the container is run.</li>
<li>Other blobs may be present in the <code>def</code> file. See <a href="https://apptainer.org/docs/user/main/definition_files.html#definition-files">Definition files documentation</a> for more details and examples.</li>
</ul>
</li>
</ul>
<p>And now, build this image and send it over to <em>HPC</em>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic">#check this is your machine</span>
$ sudo apptainer build cuda_based_image.sif cuda_based_recipe.def <span style="color:#8f5902;font-style:italic"># building may take ~ 2-5 min, depending on your internet</span>
INFO:    Starting build...
Getting image <span style="color:#204a87">source</span> signatures
Copying blob d5d706ce7b29 <span style="color:#ce5c00;font-weight:bold">[=</span>&gt;------------------------------------<span style="color:#ce5c00;font-weight:bold">]</span> 29.2MiB / 702.5MiB
...
INFO:    Adding runscript
INFO:    Creating SIF file...
INFO:    Build complete: cuda_based_image.sif  
$
$ scp cuda_based_image.sif  hpc-login:/tudelft.net/staff-bulk/...&lt;username&gt;/apptainer <span style="color:#8f5902;font-style:italic"># send to HPC</span>
</code></pre></div><p>On <em>HPC</em>, check the image:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic"># check you are on HPC</span>
login1.hpc.tudelft.nl 
$ sinteractive --cpus-per-task<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> --mem<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1024</span> --gres<span style="color:#ce5c00;font-weight:bold">=</span>gpu --time<span style="color:#ce5c00;font-weight:bold">=</span>00:05:00
$ hostname <span style="color:#8f5902;font-style:italic"># check you are on a compute node</span>
insy13.hpc.tudelft.nl

$ apptainer run --nv -C cuda_based_image.sif <span style="color:#8f5902;font-style:italic"># --nv to use NVIDIA GPU and have CUDA support</span>
/cuda-samples/Samples/1_Utilities/deviceQuery/deviceQuery Starting...

 CUDA Device Query <span style="color:#ce5c00;font-weight:bold">(</span>Runtime API<span style="color:#ce5c00;font-weight:bold">)</span> version <span style="color:#ce5c00;font-weight:bold">(</span>CUDART static linking<span style="color:#ce5c00;font-weight:bold">)</span>

Detected <span style="color:#0000cf;font-weight:bold">1</span> CUDA Capable device<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>

Device 0: <span style="color:#4e9a06">&#34;NVIDIA GeForce GTX 1080 Ti&#34;</span>
  CUDA Driver Version / Runtime Version          12.1 / 12.1
  CUDA Capability Major/Minor version number:    6.1
  Total amount of global memory:                 <span style="color:#0000cf;font-weight:bold">11172</span> MBytes <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11714887680</span> bytes<span style="color:#ce5c00;font-weight:bold">)</span>
  <span style="color:#ce5c00;font-weight:bold">(</span>028<span style="color:#ce5c00;font-weight:bold">)</span> Multiprocessors, <span style="color:#ce5c00;font-weight:bold">(</span>128<span style="color:#ce5c00;font-weight:bold">)</span> CUDA Cores/MP:    <span style="color:#0000cf;font-weight:bold">3584</span> CUDA Cores
  GPU Max Clock rate:                            <span style="color:#0000cf;font-weight:bold">1582</span> MHz <span style="color:#ce5c00;font-weight:bold">(</span>1.58 GHz<span style="color:#ce5c00;font-weight:bold">)</span>
  Memory Clock rate:                             <span style="color:#0000cf;font-weight:bold">5505</span> Mhz
  Memory Bus Width:                              352-bit
  L2 Cache Size:                                 <span style="color:#0000cf;font-weight:bold">2883584</span> bytes
  Maximum Texture Dimension Size <span style="color:#ce5c00;font-weight:bold">(</span>x,y,z<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#000">1D</span><span style="color:#ce5c00;font-weight:bold">=(</span>131072<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">2D</span><span style="color:#ce5c00;font-weight:bold">=(</span>131072, 65536<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#000">3D</span><span style="color:#ce5c00;font-weight:bold">=(</span>16384, 16384, 16384<span style="color:#ce5c00;font-weight:bold">)</span>
  Maximum Layered 1D Texture Size, <span style="color:#ce5c00;font-weight:bold">(</span>num<span style="color:#ce5c00;font-weight:bold">)</span> layers  <span style="color:#000">1D</span><span style="color:#ce5c00;font-weight:bold">=(</span>32768<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#0000cf;font-weight:bold">2048</span> layers
  Maximum Layered 2D Texture Size, <span style="color:#ce5c00;font-weight:bold">(</span>num<span style="color:#ce5c00;font-weight:bold">)</span> layers  <span style="color:#000">2D</span><span style="color:#ce5c00;font-weight:bold">=(</span>32768, 32768<span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#0000cf;font-weight:bold">2048</span> layers
  Total amount of constant memory:               <span style="color:#0000cf;font-weight:bold">65536</span> bytes
  Total amount of shared memory per block:       <span style="color:#0000cf;font-weight:bold">49152</span> bytes
  Total shared memory per multiprocessor:        <span style="color:#0000cf;font-weight:bold">98304</span> bytes
  Total number of registers available per block: <span style="color:#0000cf;font-weight:bold">65536</span>
  Warp size:                                     <span style="color:#0000cf;font-weight:bold">32</span>
  Maximum number of threads per multiprocessor:  <span style="color:#0000cf;font-weight:bold">2048</span>
  Maximum number of threads per block:           <span style="color:#0000cf;font-weight:bold">1024</span>
  Max dimension size of a thread block <span style="color:#ce5c00;font-weight:bold">(</span>x,y,z<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#ce5c00;font-weight:bold">(</span>1024, 1024, 64<span style="color:#ce5c00;font-weight:bold">)</span>
  Max dimension size of a grid size    <span style="color:#ce5c00;font-weight:bold">(</span>x,y,z<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#ce5c00;font-weight:bold">(</span>2147483647, 65535, 65535<span style="color:#ce5c00;font-weight:bold">)</span>
  Maximum memory pitch:                          <span style="color:#0000cf;font-weight:bold">2147483647</span> bytes
  Texture alignment:                             <span style="color:#0000cf;font-weight:bold">512</span> bytes
  Concurrent copy and kernel execution:          Yes with <span style="color:#0000cf;font-weight:bold">2</span> copy engine<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
  Run <span style="color:#204a87">time</span> limit on kernels:                     No
  Integrated GPU sharing Host Memory:            No
  Support host page-locked memory mapping:       Yes
  Alignment requirement <span style="color:#204a87;font-weight:bold">for</span> Surfaces:            Yes
  Device has ECC support:                        Disabled
  Device supports Unified Addressing <span style="color:#ce5c00;font-weight:bold">(</span>UVA<span style="color:#ce5c00;font-weight:bold">)</span>:      Yes
  Device supports Managed Memory:                Yes
  Device supports Compute Preemption:            Yes
  Supports Cooperative Kernel Launch:            Yes
  Supports MultiDevice Co-op Kernel Launch:      Yes
  Device PCI Domain ID / Bus ID / location ID:   <span style="color:#0000cf;font-weight:bold">0</span> / <span style="color:#0000cf;font-weight:bold">141</span> / <span style="color:#0000cf;font-weight:bold">0</span>
  Compute Mode:
     &lt; Default <span style="color:#ce5c00;font-weight:bold">(</span>multiple host threads can use ::cudaSetDevice<span style="color:#ce5c00;font-weight:bold">()</span> with device simultaneously<span style="color:#ce5c00;font-weight:bold">)</span> &gt;

deviceQuery, CUDA <span style="color:#000">Driver</span> <span style="color:#ce5c00;font-weight:bold">=</span> CUDART, CUDA Driver <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> 12.1, CUDA Runtime <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> 12.1, <span style="color:#000">NumDevs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#000">Result</span> <span style="color:#ce5c00;font-weight:bold">=</span> PASS
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <p>Always pass <code>--nv</code> to apptainer to run GPU-accelerated applications or libraries inside the container. Note that you also need <strong>1)</strong> your host system must have NVIDIA GPU drivers installed and compatible with the version of Singularity you are using, and <strong>2)</strong> the container you are running should have the necessary dependencies and configurations to support GPU acceleration.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ apptainer shell --nv -C cuda_based_image.sif
</code></pre></div>

</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Building container images from a recipe file is recommended to ensure the reproducibility of the resulting container image. However, there can be cases of complex dependencies where it is not clear upfront how the software installations and dependencies should be set up. In such cases, it is possible to interactively develop the image by building it in <code>writable sandbox</code> mode first. In such cases, take note of all installation commands used in the sandbox, so you can include them in a recipe file. See <a href="https://apptainer.org/docs/user/main/quick_start.html#sandbox-directories">Apptainer Sandbox Directories</a> for more details.

</div>

<h3 id="building-from-local-image-file">Building from local image file</h3>
<p>During software development, it is common to incrementally build code and go through many iterations of debugging and testing. A development container may be used in this process.
In such scenarios, re-building the container from the base image with each debugging or testing iteration becomes taxing very quickly, due to dependencies and installations involved.
Instead, the <code>Bootstrap: localimage</code> and <code>From:&lt;path/to/local/image&gt;</code> header can be used to base the development container on some local image.</p>
<p>As an example, assume it is desirable to develop some code on the basis of the <code>cuda_based_recipe.sif</code> image created in the <a href="#building-images">Building images</a> section.  Building from the original <code>cuda_based_recipe.def</code> file can take ~ 4 minutes.
However, if the <code>*.sif</code> file is already available, building on top of it, via a <code>dev_on_cuda_based_recipe.def</code> file as below, takes ~ 2 minutes. This is already a time saving  factor of 2 in this case.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic"># check this is your machine</span>
$ cat dev_on_cuda_based_recipe.def <span style="color:#8f5902;font-style:italic"># def file for an image based on localimage</span>
<span style="color:#8f5902;font-style:italic"># Header</span>
Bootstrap: localimage
From: cuda_based_recipe.sif

<span style="color:#8f5902;font-style:italic"># (Optional) Sections/ data blobs</span>
%runscript
    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Arguments received: </span><span style="color:#000">$*</span><span style="color:#4e9a06">&#34;</span>
    <span style="color:#204a87">exec</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>

$
$ sudo apptainer build dev_image.sif <span style="color:#8f5902;font-style:italic"># build the image</span>
INFO:    Starting build...
INFO:    Verifying bootstrap image cuda_based_recipe.sif
WARNING: integrity: signature not found <span style="color:#204a87;font-weight:bold">for</span> object group <span style="color:#0000cf;font-weight:bold">1</span>
WARNING: Bootstrap image could not be verified, but build will <span style="color:#204a87;font-weight:bold">continue</span>.
INFO:    Adding runscript
INFO:    Creating SIF file...
INFO:    Build complete: dev_image.sif
$
$ apptainer run  dev_image.sif <span style="color:#4e9a06">&#34;hello world&#34;</span> <span style="color:#8f5902;font-style:italic"># check runscript of the new def file is executed</span>
INFO:    gocryptfs not found, will not be able to use gocryptfs
Arguments received: hello world
hello world
$
$ apptainer shell  dev_image.sif <span style="color:#8f5902;font-style:italic"># further look inside the image</span>
Apptainer&gt; 
Apptainer&gt; ls /cuda-samples/Samples/1_Utilities/deviceQuery/deviceQuery <span style="color:#8f5902;font-style:italic"># commands installed in the original image are available</span>
/cuda-samples/Samples/1_Utilities/deviceQuery/deviceQuery

Apptainer&gt;
Apptainer&gt; cat /.singularity.d/bootstrap_history/Apptainer0 <span style="color:#8f5902;font-style:italic"># The original def file is also preserved </span>
bootstrap: docker
from: nvidia/cuda:12.1.1-devel-ubuntu22.04

%runscript
    /cuda-samples/Samples/1_Utilities/deviceQuery/deviceQuery  


%post
    apt-get update <span style="color:#8f5902;font-style:italic"># update system</span>
    apt-get install -y git   <span style="color:#8f5902;font-style:italic"># install git</span>
    git clone https://github.com/NVIDIA/cuda-samples.git  <span style="color:#8f5902;font-style:italic"># clone target repository</span>
    <span style="color:#204a87">cd</span> cuda-samples
    git fetch origin --tags <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> git checkout v12.1 <span style="color:#8f5902;font-style:italic"># fetch certain repository version</span>
    <span style="color:#204a87">cd</span> Samples/1_Utilities/deviceQuery <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make <span style="color:#8f5902;font-style:italic"># install certain tool</span>
</code></pre></div><p>As can be seen in this example, the new def file not only preserves the dependencies of the original image, but it also preserves a complete history of all build processes while giving flexible environment that can be customized as need arises.</p>
<h3 id="deploying-conda-in-a-container">Deploying conda in a container</h3>
<p>There might be situations where you have a certain conda environment in your local machine that you need to set up in <em>HPC</em> to commence your analysis. In such cases, deploying your conda environment in a container and sending this container to <em>HPC</em> does the job for you.</p>
<p>As an example, let&rsquo;s create a simple demo environment, <code>demo-env</code> in our local machine,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hostname <span style="color:#8f5902;font-style:italic"># check this is your machine</span>
$ conda create -n demo-env <span style="color:#000">python</span><span style="color:#ce5c00;font-weight:bold">=</span>3.10 <span style="color:#8f5902;font-style:italic"># create an environment containing python3.8</span>
$ conda activate demo-env
$ conda install numpy <span style="color:#8f5902;font-style:italic"># install some conda libraries</span>
$ pip install matplotlib <span style="color:#8f5902;font-style:italic"># install some pip libraries</span>
$ conda env <span style="color:#204a87">export</span> --from-history &gt; demo-env.yml <span style="color:#8f5902;font-style:italic"># flag added to avoid unnecessary dependencies</span>
$ <span style="color:#8f5902;font-style:italic"># You may manually remove the Prefix line from this file</span>
$ cat demo-env.yml <span style="color:#8f5902;font-style:italic"># check the environment file</span>
name: demo-env
channels:
  - defaults
dependencies:
  - <span style="color:#000">python</span><span style="color:#ce5c00;font-weight:bold">=</span>3.10
  - numpy
$ <span style="color:#8f5902;font-style:italic"># Notice pip-installed libraries are not included in this file</span>
</code></pre></div><p>Now, it is time to create the container image. One option is to base the image on <code>condaforge/mambaforge</code>, which is a minimal Ubuntu installation with <code>conda</code> preinstalled at <code>/opt/conda</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat demo-env-recipe.def
Bootstrap: docker
From: condaforge/mambaforge

%files
    demo-env.yml /opt

%post
    conda env create -f /opt/demo-env.yml <span style="color:#8f5902;font-style:italic"># create environment from  yml file</span>
    conda clean -afy <span style="color:#8f5902;font-style:italic"># remove unused packages and caches</span>
    <span style="color:#204a87">exec</span> /opt/conda/envs/demo-env/bin/pip install matplotlib <span style="color:#8f5902;font-style:italic"># install PyPI libraries</span>
</code></pre></div><p>This file is similar to the file in the <a href="/tutorials/singularity/#building-images">Building images</a>, with the addition of <code>%files</code> area. <code>%files</code> specifies the files in the host system (ie, your machine) that need to be copied to the container image, and optionally, where should they be available. In the previous example, the <code>demo-env.yml</code> file will be available in <code>/opt/</code> in the container.</p>
<p>Now, time to build and check the image:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apptainer build demo-env-image.sif demo-env-recipe.def
INFO:    Starting build...
Getting image <span style="color:#204a87">source</span> signatures
...
INFO:    Creating SIF file...       
INFO:    Build complete: demo-env-image.sif
$
$ apptainer shell -C demo-env-image.sif 
Apptainer&gt; 
Apptainer&gt; <span style="color:#204a87">source</span> activate /opt/conda/envs/demo-env/ <span style="color:#8f5902;font-style:italic"># activate the environment</span>
<span style="color:#ce5c00;font-weight:bold">(</span>demo-env<span style="color:#ce5c00;font-weight:bold">)</span> Apptainer&gt; python                         <span style="color:#8f5902;font-style:italic"># run python and check imports</span>
Python 3.10.11 <span style="color:#ce5c00;font-weight:bold">(</span>main, May <span style="color:#0000cf;font-weight:bold">16</span> 2023, 00:28:57<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span>GCC 11.2.0<span style="color:#ce5c00;font-weight:bold">]</span> on linux
Type <span style="color:#4e9a06">&#34;help&#34;</span>, <span style="color:#4e9a06">&#34;copyright&#34;</span>, <span style="color:#4e9a06">&#34;credits&#34;</span> or <span style="color:#4e9a06">&#34;license&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information.
&gt;&gt;&gt; import numpy
&gt;&gt;&gt; import matplotlib
&gt;&gt;&gt; exit<span style="color:#ce5c00;font-weight:bold">()</span>
Apptainer&gt; <span style="color:#204a87">exit</span>
$ scp demo-env-image.sif hpc-login:/tudelft.net/staff-bulk/...&lt;username&gt;/apptainer
</code></pre></div><p>Now, to use the environment in this image to run code in a file, <code>analysis.py</code>, which uses some data to generate a plot:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat analysis.py <span style="color:#8f5902;font-style:italic"># check python code</span>
<span style="color:#8f5902;font-style:italic">#!/usr/bin/env python3</span>

import matplotlib.pyplot as plt
import numpy as np

<span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> np.linspace<span style="color:#ce5c00;font-weight:bold">(</span>0, <span style="color:#0000cf;font-weight:bold">2</span> * np.pi, 100<span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> np.sin<span style="color:#ce5c00;font-weight:bold">(</span>x<span style="color:#ce5c00;font-weight:bold">)</span>

plt.plot<span style="color:#ce5c00;font-weight:bold">(</span>x, y<span style="color:#ce5c00;font-weight:bold">)</span>
plt.title<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Sine Wave&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
plt.savefig<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sine_wave.png&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
$ 
$ apptainer <span style="color:#204a87">exec</span> demo-env-image.sif /bin/bash -c <span style="color:#4e9a06">&#34;source activate /opt/conda/envs/demo-env &amp;&amp; python analysis.py&#34;</span>
$ ls <span style="color:#8f5902;font-style:italic"># check the image file was created</span>
sine_wave.png
</code></pre></div>

<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    In the last example, the container read and wrote a file to the host system directly. This behavior is risky. You are strongly recommended to expose only the desired host directories to the container. See <a href="daicdocumentation/tutorials/singularity/#exposing-host-directories">Exposing host directories</a>

</div>

<h2 id="exposing-host-directories">Exposing host directories</h2>
<p>Depending on use case, it may be necessary for the container to read or write data from or to the host system. For example, to expose only files in a host directory called <code>ProjectDataDir</code> to the container image&rsquo;s <code>/mnt</code> directory, add the <code>--bind</code> directive with appropriate <code>&lt;hostDir&gt;:&lt;containerDir&gt;</code> mapping to the commands you use to launch the container, in conjunction with the <code>-C</code> flag eg, <code>shell</code> or <code>exec</code> as below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls  <span style="color:#8f5902;font-style:italic"># check ProjectDataDir exists</span>
$ ls ProjectDataDir <span style="color:#8f5902;font-style:italic"># check contents of ProjectDataDir</span>
raw_data.txt
$ apptainer shell -C --bind ProjectDataDir:/mnt ubuntu_latest.sif <span style="color:#8f5902;font-style:italic"># Launch the container with ProjectDataDir bound</span>
Apptainer&gt; ls
Apptainer&gt; ls /mnt <span style="color:#8f5902;font-style:italic"># check the files are accessible inside the container</span>
raw_data.txt
Apptainer&gt; <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Date: </span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span> &gt;&gt; raw_data.txt <span style="color:#8f5902;font-style:italic"># edit the file</span>
Apptainer&gt; tail -n1 raw_data.txt <span style="color:#8f5902;font-style:italic"># check the date was written to the file</span>
Apptainer&gt; <span style="color:#204a87">exit</span> <span style="color:#8f5902;font-style:italic"># exit the container</span>
$ tail -n1 ProjectDataDir/raw_data.txt <span style="color:#8f5902;font-style:italic"># check the change persisted</span>
</code></pre></div><p>If the desire is to expose this directory as read-only inside the container, the <code>--mount</code> directive should be used instead of <code>--bind</code>, with <code>ro</code>designation as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apptainer shell -C --mount <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>bind,source<span style="color:#ce5c00;font-weight:bold">=</span>ProjectDataDir,destination<span style="color:#ce5c00;font-weight:bold">=</span>/mnt,ro ubuntu_latest.sif <span style="color:#8f5902;font-style:italic"># Launch the container with ProjectDataDir bound</span>
Apptainer&gt; ls /mnt <span style="color:#8f5902;font-style:italic"># check the files are accessible inside the container</span>
raw_data.txt
Apptainer&gt; <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Date: </span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span> &gt;&gt; /mnt/raw_data.txt <span style="color:#8f5902;font-style:italic"># attempt to edit fails</span>
bash: tst: Read-only file system
</code></pre></div>
        <div class="section-index">
    
    
    
    
    
    
    
    
    
</div>

	
		<style>
  .feedback--answer {
    display: inline-block;
  }
  .feedback--answer-no {
    margin-left: 1em;
  }
  .feedback--response {
    display: none;
    margin-top: 1em;
  }
  .feedback--response__visible {
    display: block;
  }
</style>
<div class="d-print-none">
<h2 class="feedback--title">Feedback</h2>
<p class="feedback--question">Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
  Glad to hear it! Please <a href="https://github.com/USERNAME/REPOSITORY/issues/new">tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
  Sorry to hear that. Please <a href="https://github.com/USERNAME/REPOSITORY/issues/new">tell us how we can improve</a>.
</p>
</div>
<script>
  const yesButton = document.querySelector('.feedback--answer-yes');
  const noButton = document.querySelector('.feedback--answer-no');
  const yesResponse = document.querySelector('.feedback--response-yes');
  const noResponse = document.querySelector('.feedback--response-no');
  const disableButtons = () => {
    yesButton.disabled = true;
    noButton.disabled = true;
  };
  const sendFeedback = (value) => {
    if (typeof ga !== 'function') return;
    const args = {
      command: 'send',
      hitType: 'event',
      category: 'Helpful',
      action: 'click',
      label: window.location.pathname,
      value: value
    };
    ga(args.command, args.hitType, args.category, args.action, args.label, args.value);
  };
  yesButton.addEventListener('click', () => {
    yesResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(1);
  });
  noButton.addEventListener('click', () => {
    noResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(0);
  });
</script>

		<br />
	
	
	<div class="text-muted mt-5 pt-3 border-top">
  Last modified July 14, 2023: <a href="https://gitlab.tudelft.nl/aeaahmed/hpcdocumentation/commit/74b2688a845c880a7897e4b8cf00dc0ccd12ff9d">rename singularity tutorial to containers (74b2688)</a>
</div>

</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener" href="" aria-label="">
      <i class=""></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener" href="" aria-label="">
      <i class=""></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="" aria-label="">
    <a class="text-white" target="_blank" rel="noopener" href="" aria-label="">
      <i class=""></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="/daicdocumentation/js/main.min.7f4bcb49bdbe0fca22211dd75286bcda06ea254edfe4f32d08ff008cb8fa76ed.js" integrity="sha256-f0vLSb2&#43;D8oiIR3XUoa82gbqJU7f5PMtCP8AjLj6du0=" crossorigin="anonymous"></script>
<script src='/daicdocumentation/js/prism.js'></script>
<script src='/daicdocumentation/js/tabpane-persist.js'></script>

  </body>
</html>